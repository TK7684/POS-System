<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dropdown Offline Support Test</title>
  <style>
    body {
      font-family: 'Sarabun', Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    h2 {
      color: #555;
      margin-top: 0;
    }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .status.online {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.offline {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    select.dropdown-offline {
      border-color: #ff9800;
      background-color: #fff3e0;
    }
    
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #45a049;
    }
    
    button.secondary {
      background: #2196F3;
    }
    
    button.secondary:hover {
      background: #0b7dda;
    }
    
    button.danger {
      background: #f44336;
    }
    
    button.danger:hover {
      background: #da190b;
    }
    
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #2196F3;
    }
    
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    
    .log-entry.error {
      color: #d32f2f;
    }
    
    .log-entry.success {
      color: #388e3c;
    }
    
    .log-entry.info {
      color: #1976d2;
    }
  </style>
</head>
<body>
  <h1>üß™ Dropdown Offline Support Test</h1>
  
  <div class="test-section">
    <h2>Connection Status</h2>
    <div id="connectionStatus" class="status online">
      üü¢ Online
    </div>
    <button onclick="simulateOffline()">Simulate Offline</button>
    <button onclick="simulateOnline()" class="secondary">Simulate Online</button>
  </div>
  
  <div class="test-section">
    <h2>Test Dropdowns</h2>
    
    <div class="info">
      <strong>Test Instructions:</strong>
      <ol>
        <li>Click "Load Dropdowns" to populate with mock data</li>
        <li>Click "Simulate Offline" to test offline mode</li>
        <li>Click "Load Dropdowns" again - should use cached data</li>
        <li>Click "Clear Cache" and try loading while offline - should fail</li>
        <li>Click "Simulate Online" to restore connection</li>
      </ol>
    </div>
    
    <label for="testIngredients">Ingredients Dropdown:</label>
    <select id="testIngredients">
      <option value="">Not loaded yet</option>
    </select>
    
    <label for="testMenus">Menus Dropdown:</label>
    <select id="testMenus">
      <option value="">Not loaded yet</option>
    </select>
    
    <button onclick="loadDropdowns()">Load Dropdowns</button>
    <button onclick="clearCache()" class="danger">Clear Cache</button>
    <button onclick="checkCacheVersion()" class="secondary">Check Cache Version</button>
  </div>
  
  <div class="test-section">
    <h2>Test Log</h2>
    <div id="testLog" class="log"></div>
    <button onclick="clearLog()" class="secondary">Clear Log</button>
  </div>
  
  <script src="CacheManager.js"></script>
  <script src="js/core/DropdownManager.js"></script>
  
  <script>
    // Initialize managers
    const cacheManager = new CacheManager();
    const dropdownManager = new DropdownManager(cacheManager);
    
    // Mock backend functions
    window.google = {
      script: {
        run: {
          withSuccessHandler: function(callback) {
            this._successHandler = callback;
            return this;
          },
          withFailureHandler: function(callback) {
            this._failureHandler = callback;
            return this;
          },
          getIngredients: function() {
            setTimeout(() => {
              if (!navigator.onLine) {
                this._failureHandler(new Error('Network error: offline'));
              } else {
                const mockData = [
                  { id: 'ING001', name: '‡∏Å‡∏∏‡πâ‡∏á', stock_unit: 'piece', buy_unit: 'kg', buy_to_stock_ratio: 43 },
                  { id: 'ING002', name: '‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤', stock_unit: 'ml', buy_unit: 'l', buy_to_stock_ratio: 1000 },
                  { id: 'ING003', name: '‡∏û‡∏£‡∏¥‡∏Å', stock_unit: 'g', buy_unit: 'kg', buy_to_stock_ratio: 1000 }
                ];
                this._successHandler(mockData);
              }
            }, 500);
          },
          getMenus: function() {
            setTimeout(() => {
              if (!navigator.onLine) {
                this._failureHandler(new Error('Network error: offline'));
              } else {
                const mockData = [
                  { id: 'MENU001', name: '‡∏Å‡∏∏‡πâ‡∏á‡πÅ‡∏ã‡πà‡∏ö', price: 120 },
                  { id: 'MENU002', name: '‡∏™‡πâ‡∏°‡∏ï‡∏≥', price: 80 },
                  { id: 'MENU003', name: '‡∏•‡∏≤‡∏ö‡∏´‡∏°‡∏π', price: 90 }
                ];
                this._successHandler(mockData);
              }
            }, 500);
          }
        }
      }
    };
    
    // Update connection status display
    function updateConnectionStatus() {
      const statusDiv = document.getElementById('connectionStatus');
      if (navigator.onLine) {
        statusDiv.className = 'status online';
        statusDiv.textContent = 'üü¢ Online';
      } else {
        statusDiv.className = 'status offline';
        statusDiv.textContent = 'üî¥ Offline';
      }
    }
    
    // Listen for online/offline events
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    
    // Simulate offline mode
    function simulateOffline() {
      Object.defineProperty(navigator, 'onLine', {
        writable: true,
        value: false
      });
      window.dispatchEvent(new Event('offline'));
      updateConnectionStatus();
      log('Simulated offline mode', 'info');
    }
    
    // Simulate online mode
    function simulateOnline() {
      Object.defineProperty(navigator, 'onLine', {
        writable: true,
        value: true
      });
      window.dispatchEvent(new Event('online'));
      updateConnectionStatus();
      log('Simulated online mode', 'success');
    }
    
    // Load dropdowns
    async function loadDropdowns() {
      log('Loading dropdowns...', 'info');
      
      try {
        const ingredientsSelect = document.getElementById('testIngredients');
        const menusSelect = document.getElementById('testMenus');
        
        await dropdownManager.populateIngredients(ingredientsSelect);
        log('‚úì Ingredients loaded successfully', 'success');
        
        await dropdownManager.populateMenus(menusSelect);
        log('‚úì Menus loaded successfully', 'success');
        
        // Check if using cached data
        if (dropdownManager.state.usingCachedData.has('ingredients')) {
          log('‚ö† Using cached ingredients (offline or expired)', 'info');
        }
        if (dropdownManager.state.usingCachedData.has('menus')) {
          log('‚ö† Using cached menus (offline or expired)', 'info');
        }
        
      } catch (error) {
        log('‚úó Failed to load dropdowns: ' + error.message, 'error');
      }
    }
    
    // Clear cache
    async function clearCache() {
      try {
        await dropdownManager.clearCache();
        log('‚úì Cache cleared successfully', 'success');
      } catch (error) {
        log('‚úó Failed to clear cache: ' + error.message, 'error');
      }
    }
    
    // Check cache version
    function checkCacheVersion() {
      const versionInfo = dropdownManager.getCacheVersionInfo();
      log(`Cache Version Info:`, 'info');
      log(`  Current: ${versionInfo.currentVersion}`, 'info');
      log(`  Stored: ${versionInfo.storedVersion || 'none'}`, 'info');
      log(`  Up to date: ${versionInfo.isUpToDate}`, 'info');
    }
    
    // Logging function
    function log(message, type = 'info') {
      const logDiv = document.getElementById('testLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString('th-TH');
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    // Clear log
    function clearLog() {
      document.getElementById('testLog').innerHTML = '';
    }
    
    // Initialize
    updateConnectionStatus();
    log('Test page initialized', 'success');
    log('DropdownManager ready with offline support', 'success');
  </script>
</body>
</html>
