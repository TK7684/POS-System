<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"</head> />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title><?= brand ?> ¬∑ POS</title>

  <!-- Load original styles -->
  <link rel="stylesheet" href="css/critical.css" />
  <link rel="stylesheet" href="css/mobile-optimized.css" />
  <link rel="stylesheet" href="css/ai-chat.css" />

  <!-- Load AI overlay fixes -->
  <link rel="stylesheet" href="css/ai-chat-fix.css" />

  <style>
    :</style>root{
      --spacing-xs:.25rem; --spacing-sm:.5rem; --spacing-md:1rem; --spacing-lg:1.5rem; --spacing-xl:2rem; --spacing-2xl:3rem;
      --fs-xs:.75rem; --fs-sm:.875rem; --fs-md:1rem; --fs-lg:1.125rem; --fs-xl:1.25rem; --fs-2xl:1.5rem; --fs-3xl:1.875rem; --fs-4xl:2.25rem;
      --brand:#0f766e; --brand-ink:#fff; --bg:#fff; --card:#fff; --line:#e5e7eb; --muted:#6b7280;
    }
    *{ box-sizing: border-box }
    html{ font-size:16px; -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent }
    body{ margin:0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; color:#111; background:#f6f7fb }
    .container{ width:100%; max-width:min(1200px, 100vw - 2rem); margin:0 auto; padding: 0 var(--spacing-md) }
    .title{ font-size: clamp(var(--fs-2xl), 4vw, var(--fs-4xl)); font-weight:700; margin: var(--spacing-lg) 0 var(--spacing-xs) }
    .subtitle{ font-size: var(--fs-lg); color: var(--muted); margin-bottom: var(--spacing-lg) }
    .dashboard-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-xl) }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.04) }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding: var(--spacing-md) var(--spacing-xl);
          border:2px solid transparent; border-radius:.75rem; font-size: var(--fs-md); font-weight:600; cursor:pointer; min-height:44px }
    .btn.brand{ background: var(--brand); color: var(--brand-ink) }
    .btn.ghost{ background:#fff; border-color: var(--line); color:#111 }
    .btn.pill{ border-radius:999px; padding:8px 12px; font-size: var(--fs-sm); background:#f5f7fb; border:1px solid #e6e9f0 }
    .btn.pill:hover{ filter:brightness(0.98) }
    .input{ width:100%; padding: var(--spacing-md); border:2px solid #e5e7eb; border-radius:.75rem; font-size: var(--fs-md); background:#fff }
    .input:focus{ outline:none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(15,118,110,0.1) }
    .table-container{ overflow-x:auto; margin-top: var(--spacing-lg); -webkit-overflow-scrolling: touch }
    .table{ width:100%; border-collapse: collapse; font-size: var(--fs-sm); min-width:600px }
    .table th,.table td{ padding: var(--spacing-md); text-align:left; border-bottom:1px solid #e5e7eb }
    .muted{ color: var(--muted) }
    .hide{ display:none }

    /* AI bubbles */
    .ai-msg{ display:grid; gap:6px; margin:8px 0 }
    .ai-msg .who{ font-size: var(--fs-xs); color: var(--muted) }
    .ai-bubble{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px }
    .ai-bubble.me{ background:#e6f4ff; border-color:#b3e0ff }

    /* Enhanced AI status indicator */
    .ai-status-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(15, 118, 110, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      z-index: 10001;
      display: none;
    }

    .ai-status-indicator.active { display: block; }
    .ai-status-indicator.error { background: rgba(239, 68, 68, 0.9); }
    .ai-status-indicator.success { background: rgba(34, 197, 94, 0.9); }

    @media (max-width:768px){
      :root{ --spacing-md:.75rem; --spacing-lg:1rem; --spacing-xl:1.5rem; --spacing-2xl:2rem }
      .container{ padding: 0 var(--spacing-sm) }
      .table{ font-size: var(--fs-xs) }
      .table th,.table td{ padding: var(--spacing-sm) }
    }
    @media (prefers-reduced-motion: reduce){
      *,*::before,*::after{ animation-duration:.01ms!important; animation-iteration-count:1!important; transition-duration:.01ms!important }
    }
  </style>
</head>
<body>
  <!-- AI Status Indicator --></body>
  <div id="ai-status-indicator" class="ai-status-indicator">AI: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>

  <main class="container">
    <header>
      <h</header>1 class="title"><?= brand ?> POS & Inventory</h1>
      <p class="subtitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ ¬∑ ‡∏™‡∏ï‡πä‡∏≠‡∏Å ¬∑ ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI (Fixed)</p>
    </header>

    <section class="dashboard-grid">
      <div class="card">
        <h3 style="margin:0 0 8px">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h3>
        <div id="low-stock">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ghost" onclick="refreshLowStock()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button class="btn brand" onclick="openFixedAI()">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI (Fixed)</button>
          <button class="btn ghost" onclick="resetAI()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï AI</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡πá‡∏ß</h3>
        <div style="display:grid; gap:10px">
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <input id="quick-ing" class="input" placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏∏‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà)" />
            <input id="quick-qty" class="input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1)" style="max-width:120px" />
            <input id="quick-price" class="input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)" style="max-width:160px" />
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn brand" onclick="quickAddPurchase()">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ buy_unit)</button>
            <button class="btn ghost" onclick="quickPriceSuggest()">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö)</button>
            <button class="btn ghost" onclick="quickSellMenu()">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π (‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£)</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">AI Diagnostics</h3>
        <div id="ai-diagnostics" style="font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 8px; border-radius: 4px; max-height: 150px; overflow-y: auto;">
          Loading diagnostics...
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ghost" onclick="runDiagnostics()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
          <button class="btn ghost" onclick="testAIConnection()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
          <button class="btn ghost" onclick="clearAICache()">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Enhanced AI Agent (Fixed Version) -->
  <div id="ai-agent-button" aria-label="‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Fixed)" style="
    position: fixed; right: 16px; bottom: 16px; z-index: 10002; width: 56px; height: 56px; border-radius: 50%;
    display: grid; place-items: center; background: linear-gradient(135deg, #0f766e, #14b8a6); color: #fff;
    box-shadow: 0 8px 20px rgba(15,118,110,0.4); cursor: pointer; font-size: 24px;
    transition: all 0.3s ease; -webkit-tap-highlight-color: transparent;">ü§ñ</div>

  <div id="ai-agent-panel" class="hide" role="dialog" aria-modal="true" style="
    position: fixed; right: 12px; bottom: 76px; width: min(420px, calc(100vw - 24px)); max-height: min(70vh, 560px);
    background: var(--card); border: 1px solid var(--line); border-radius: 14px; box-shadow: 0 18px 48px rgba(0,0,0,.35);
    z-index: 10003; display: flex; flex-direction: column;">

    <!-- Enhanced Header with Close/Minimize -->
    <div style="padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:8px;">
      <strong style="font-size: var(--fs-md);">ü§ñ ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô ¬∑ AI (Fixed)</strong>
      <span class="muted" id="ai-status-text" style="font-size: var(--fs-xs);">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</span>
      <div style="flex:1"></div>
      <button id="ai-minimize" class="btn ghost" aria-label="‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="padding: 4px 8px; min-height: 32px; font-size: 12px;">‚àí</button>
      <button id="ai-close" class="btn ghost" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á" style="padding: 4px 8px; min-height: 32px; font-size: 12px;">‚úñ</button>
    </div>

    <div id="ai-messages" style="padding: 12px; overflow:auto; flex:1;"></div>

    <!-- Enhanced Quick Replies -->
    <div id="ai-quick" style="padding:8px; border-top:1px solid var(--line); display:flex; flex-wrap:wrap; gap:8px;">
      <button class="btn pill" data-txt="‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Å‡∏∏‡πâ‡∏á 1 kg 120 ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡∏ï‡∏•‡∏≤‡∏î">‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Å‡∏∏‡πâ‡∏á 1 kg 120 ‡∏ö‡∏≤‡∏ó</button>
      <button class="btn pill" data-txt="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</button>
      <button class="btn pill" data-txt="‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 500 ‡∏ö‡∏≤‡∏ó">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 500 ‡∏ö‡∏≤‡∏ó</button>
      <button class="btn pill" data-txt="‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∏‡πâ‡∏á‡πÅ‡∏ä‡πà‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∏‡πâ‡∏á</button>
      <button class="btn pill" data-txt="‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏û‡∏£‡∏¥‡∏Å</button>
      <button class="btn pill" data-txt="‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
    </div>

    <div style="padding: 10px; border-top:1px solid var(--line); display:flex; gap:8px;">
      <input id="ai-input" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ã‡∏∑‡πâ‡∏≠ ‡∏û‡∏£‡∏¥‡∏Å 2 ‡∏Å‡∏¥‡πÇ‡∏• 100 ‡∏ö‡∏≤‡∏ó" />
      <button id="ai-send" class="btn brand">‡∏™‡πà‡∏á</button>
    </div>
  </div>

  <!-- Emergency Close Button (Hidden by default) -->
  <button id="ai-emergency-close" style="
    position: fixed; top: 10px; right: 10px; z-index: 10005; background: rgba(239, 68, 68, 0.9);
    color: white; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer;
    font-size: 12px; font-weight: bold; display: none; pointer-events: all;"
    onclick="forceCloseAI()">Emergency Close AI</button>

  <!-- Load original AI chat scripts -->
  <script src="js/core/AIAgentChat.js"></script>
  <script src="js/core/AIAgentChatUI.js"></script>

  <!-- Load AI overlay fixes -->
  <script src="js/fixes/AIOverlayFix.js"></script>

  <script></script>
    // ===== Enhanced AI Integration with Fixes =====
    let aiProcessingTimeout = null;
    let isMinimized = false;

    // Low Stock widget
    function refreshLowStock(){
      const el = document.getElementById('low-stock');
      el.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶';
      google.script.run.withSuccessHandler(html=>{ el.innerHTML = html; })
        .withFailureHandler(err=>{ el.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err && (err.message || err) || 'unknown'); })
        .getLowStockHTML();
    }

    // Open Fixed AI Agent
    function openFixedAI(){
      const panel = document.getElementById('ai-agent-panel');
      panel.classList.remove('hide');
      document.getElementById('ai-input').focus();
      updateAIStatus('‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');

      // Initialize AI chat if not already loaded
      if (window.aiChatUI && !window.aiChatUI.isOpen) {
        window.aiChatUI.toggleChat();
      }
    }

    // Reset AI
    function resetAI(){
      if (window.AIOverlayFix) {
        window.AIOverlayFix.resetAIChat();
        updateAIStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
      } else {
        alert('AI Overlay Fix not loaded. Please refresh the page.');
      }
    }

    // Force Close AI
    function forceCloseAI(){
      const panel = document.getElementById('ai-agent-panel');
      panel.classList.add('hide');
      if (window.aiOverlayFix) {
        window.aiOverlayFix.forceCloseChat();
      }
      updateAIStatus('‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }

    // Update AI Status
    function updateAIStatus(message, type = 'active') {
      const indicator = document.getElementById('ai-status-indicator');
      const statusText = document.getElementById('ai-status-text');

      if (message) {
        indicator.textContent = `AI: ${message}`;
        indicator.className = `ai-status-indicator ${type}`;
        indicator.classList.add('active');
      }

      if (statusText && message) {
        statusText.textContent = message;
      }

      // Auto-hide status after 3 seconds
      if (type !== 'error') {
        setTimeout(() => {
          indicator.classList.remove('active');
        }, 3000);
      }
    }

    // Quick actions (frontend helpers)
    function quickAddPurchase(){
      const ing = document.getElementById('quick-ing').value.trim();
      const qty = Number(document.getElementById('quick-qty').value || '0');
      const price = Number(document.getElementById('quick-price').value || '0');
      if (!ing || !(qty>0) || !(price>0)) { alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°'); return; }
      sendFixedText(`‡∏ã‡∏∑‡πâ‡∏≠ ${ing} ${qty} ${qty > 1 ? '‡∏Å‡∏¥‡πÇ‡∏•' : '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°'} ${price} ‡∏ö‡∏≤‡∏ó`);
    }
    function quickPriceSuggest(){
      const ing = document.getElementById('quick-ing').value.trim();
      if (!ing) { alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
      sendFixedText(`‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏≤‡∏Ñ‡∏≤ ${ing}`);
    }
    function quickSellMenu(){
      const menu = document.getElementById('quick-ing').value.trim();
      const servings = Number(document.getElementById('quick-qty').value || '1');
      const priceEach = document.getElementById('quick-price').value.trim();
      const txt = priceEach ? `‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π ${menu} ${servings} @ ${priceEach} ‡∏ö‡∏≤‡∏ó` : `‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π ${menu} ${servings}`;
      sendFixedText(txt);
    }

    // AI Diagnostics
    function runDiagnostics() {
      const diagnosticsDiv = document.getElementById('ai-diagnostics');

      if (window.AIOverlayFix) {
        const diagnostics = window.AIOverlayFix.getDiagnostics();
        diagnosticsDiv.innerHTML = `
          <strong>AI</strong> System Status:</strong><br>
          Chat UI: ${diagnostics.aiChatUI ? '‚úÖ OK' : '‚ùå Error'}<br>
          AI Agent: ${diagnostics.aiAgent ? '‚úÖ OK' : '‚ùå Error'}<br>
          Chat Window: ${diagnostics.chatWindow ? '‚úÖ OK' : '‚ùå Error'}<br>
          Close Button: ${diagnostics.closeButton ? '‚úÖ OK' : '‚ùå Error'}<br>
          Minimize Button: ${diagnostics.minimizeButton ? '‚úÖ OK' : '‚ùå Error'}<br>
          Processing: ${diagnostics.isProcessing ? '‚ö†Ô∏è Stuck' : '‚úÖ OK'}<br>
          Open: ${diagnostics.isOpen ? '‚úÖ Open' : '‚ùå Closed'}<br>
          LocalStorage: ${diagnostics.localStorage ? '‚úÖ OK' : '‚ùå Empty'}<br>
          <br><small>Last checked: ${new Date().toLocaleString('th-TH')}</small>
        `;
      } else {
        diagnosticsDiv.innerHTML = '‚ùå AI Overlay Fix not loaded';
      }
    }

    function testAIConnection() {
      updateAIStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'active');

      // Test with a simple message
      google.script.run.withSuccessHandler(function(result) {
        updateAIStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        console.log('AI Connection Test Result:', result);
      }).withFailureHandler(function(error) {
        updateAIStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
        console.error('AI Connection Test Error:', error);
      }).testAIProcessing();
    }

    function clearAICache() {
      if (window.AIOverlayFix) {
        window.AIOverlayFix.resetAIChat();
        updateAIStatus('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏•‡πâ‡∏ß', 'success');
      }
    }

    // Enhanced AI Agent front-end with fixes
    (function(){
      const $ = (sel)=>document.querySelector(sel);
      const msgs = $('#ai-messages');
      const panel = $('#ai-agent-panel');
      const btn = $('#ai-agent-button');
      const closeBtn = $('#ai-close');
      const minimizeBtn = $('#ai-minimize');

      function pushMsg(who, html){
        const wrap = document.createElement('div');
        wrap.className = 'ai-msg';
        wrap.innerHTML = `<div class="who">${who}</div><div class="ai-bubble ${who === '‡∏Ñ‡∏∏‡∏ì' ? 'me':''}">${html}</div>`;
        msgs.appendChild(wrap);
        msgs.scrollTop = msgs.scrollHeight;
      }

      function onConfirmResult(res){
        if (res && res.status === 'applied') {
          if (res.result && res.result.type === 'html') pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô', res.result.html);
          else pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô', '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
          if (typeof refreshLowStock === 'function') refreshLowStock();
        } else if (res && res.status === 'noop') {
          pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô', res.message || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á');
        } else {
          pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (res && res.error ? res.error : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
        }
        updateAIStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'success');
      }

      function onError(err){
        pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô','‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err ? err.message || String(err) : 'unknown'));
        updateAIStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }

      function getUserKey(){
        try {
          return localStorage.getItem('userKey') || 'guest';
        } catch(e) {
          return 'guest';
        }
      }

      function pushPlan(summary, token, autoApply){
        const wrap = document.createElement('div');
        wrap.className = 'ai-msg';
        wrap.innerHTML = `
          <div class="who">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô</div>
          <div class="ai-bubble">
            <div style="margin-bottom:8px">${summary}</div>
            <div class="ai-actions" style="display:flex; gap:8px;">
              <button class="btn brand" data-token="${token}" id="ai-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
              <button class="btn" id="ai-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </div>`;
        msgs.appendChild(wrap);
        msgs.scrollTop = msgs.scrollHeight;

        const doConfirm = () => {
          wrap.querySelector('#ai-confirm').disabled = true;
          wrap.querySelector('#ai-cancel').disabled = true;
          updateAIStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'active');

          google.script.run.withSuccessHandler(onConfirmResult).withFailureHandler(onError)
            .agentConfirm({ userKey: getUserKey(), token });
        };

        wrap.querySelector('#ai-confirm').onclick = doConfirm;
        wrap.querySelector('#ai-cancel').onclick = () => {
          pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
          updateAIStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'success');
        };

        if (autoApply === true) doConfirm();
      }

      function sendFixedText(raw){
        const t = (raw != null ? raw : $('#ai-input').value).trim();
        if (!t) return;

        pushMsg('‡∏Ñ‡∏∏‡∏ì', t);
        $('#ai-input').value = '';
        updateAIStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'active');

        // Set processing timeout
        aiProcessingTimeout = setTimeout(() => {
          pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô', '‚è∞ ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
          updateAIStatus('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤', 'error');
        }, 25000); // 25 second timeout

        google.script.run.withSuccessHandler(function(res){
          clearTimeout(aiProcessingTimeout);

          if (!res || res.status !== 'ok') {
            pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ: ' + (res && res.error ? res.error : 'unknown'));
            updateAIStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            return;
          }

          const { plan, parsed, token } = res;
          if (!plan) {
            pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô','‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á"');
            updateAIStatus('‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', 'error');
            return;
          }

          const hint = parsed && parsed.intent ? `<div class="muted" style="font-size: var(--fs-xs)">intent: ${parsed.intent}</div>` : '';
          pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô', `üîé <b>‡∏™‡∏£</b>‡∏∏‡∏õ</b>: ${plan.summary}${hint}`);

          if (plan.applyFn && plan.applyFn !== 'none') {
            pushPlan(plan.summary, token, plan.autoApply === true);
          } else {
            updateAIStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'success');
          }
        }).withFailureHandler(function(error){
          clearTimeout(aiProcessingTimeout);
          onError(error);
        }).agentPlan({ userKey: getUserKey(), text: t });
      }

      window.sendFixedText = sendFixedText;

      // Enhanced UI + handlers with fixes
      btn.onclick = ()=> {
        panel.classList.toggle('hide');
        if (!panel.classList.contains('hide')) {
          $('#ai-input').focus();
          updateAIStatus('‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
      };

      closeBtn.onclick = ()=> {
        panel.classList.add('hide');
        if (window.aiOverlayFix) {
          window.aiOverlayFix.forceCloseChat();
        }
        updateAIStatus('‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
      };

      minimizeBtn.onclick = ()=> {
        isMinimized = !isMinimized;
        if (isMinimized) {
          panel.style.height = '60px';
          msgs.style.display = 'none';
          $('#ai-quick').style.display = 'none';
          panel.querySelector('input').parentElement.style.display = 'none';
          minimizeBtn.textContent = '‚ñ°';
          updateAIStatus('‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } else {
          panel.style.height = '';
          msgs.style.display = '';
          $('#ai-quick').style.display = '';
          panel.querySelector('input').parentElement.style.display = '';
          minimizeBtn.textContent = '‚àí';
          updateAIStatus '‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
      };

      $('#ai-send').onclick = ()=> sendFixedText();
      $('#ai-input').addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendFixedText();
        }
      });

      // Quick replies
      document.querySelectorAll('#ai-quick .btn').forEach(b=>
        b.addEventListener('click', ()=> sendFixedText(b.getAttribute('data-txt')))
      );

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !panel.classList.contains('hide')) {
          closeBtn.click();
        }
      });

      // Double-click outside to close
      document.addEventListener('dblclick', (e) => {
        if (!panel.contains(e.target) && !btn.contains(e.target) && !panel.classList.contains('hide')) {
          closeBtn.click();
        }
      });

      // Enhanced greeting + initial data
      setTimeout(()=>{
        pushMsg('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô','ü§ñ **‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Fixed Version)**<br><br>**‡∏â‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì:**<br>üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö<br>üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢<br>üç≤ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏°‡∏ô‡∏π<br>üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å<br><br>**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:**<br>- ‡∏ã‡∏∑‡πâ‡∏≠ ‡∏û‡∏£‡∏¥‡∏Å 2 ‡∏Å‡∏¥‡πÇ‡∏• 100 ‡∏ö‡∏≤‡∏ó<br>- ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 500 ‡∏ö‡∏≤‡∏ó<br>- ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∏‡πâ‡∏á‡πÅ‡∏ä‡πà‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤<br>- ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà<br><br>**‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©:**<br>- ESC: ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á<br>- ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á: ‡∏õ‡∏¥‡∏î<br>- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠: ‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á');
        updateAIStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'success');
      }, 500);

      refreshLowStock();

      // Run initial diagnostics
      setTimeout(() => {
        runDiagnostics();
      }, 1000);

    })();
  </script>
</body>
</html>
